<?php
 namespace Informunity\Classes; class UpgradeModule { private $moduleName; private $timeout; private $currentVersion; private $cached; private $modulesDir; public function __construct($config) { goto HLJBZ; QnWq2: $filename = $name . "\x2e\164\141\162\56\147\172"; goto u3mol; qzKTQ: $this->modulesDir = $amp_conf["\101\x4d\120\127\x45\102\x52\x4f\117\x54"] . "\57\141\x64\x6d\x69\156\x2f\x6d\x6f\144\x75\154\145\163"; goto Ex2cr; Sqn92: $name = $this->moduleName; goto QnWq2; bn9gJ: global $amp_conf; goto Sqn92; HLJBZ: $this->timeout = $config["\164\x69\155\x65\157\165\x74"]; goto D9IqY; u3mol: $cachePath = $amp_conf["\x41\115\x50\x57\105\x42\122\117\x4f\x54"] . "\x2f\141\x64\x6d\x69\x6e\x2f\x6d\157\x64\165\x6c\x65\163\57\137\x63\141\x63\x68\x65\x2f"; goto qzKTQ; D9IqY: $this->moduleName = $config["\x6d\x6f\x64\165\154\x65\x4e\141\155\145"]; goto J8I_E; J8I_E: $this->currentVersion = $config["\x76\145\162\163\151\x6f\156"]; goto bn9gJ; Ex2cr: $this->cached = $cachePath . $filename; goto VAQRV; VAQRV: } private function getOnline() { goto Gl9Rj; Gl9Rj: $url = \FreePBX::Modules()->getXML($this->moduleName)->updateurl; goto ScOQ7; WrFjy: $data = curl_exec($curl); goto W3TLS; juD_I: $optarray = array(CURLOPT_URL => $url[0], CURLOPT_RETURNTRANSFER => true, CURLOPT_HEADER => false, CURLOPT_CONNECTTIMEOUT => $this->timeout, CURLOPT_TIMEOUT => $this->timeout); goto a7zN6; OcFQz: return json_decode($data); goto GZynK; ScOQ7: $curl = curl_init(); goto juD_I; a7zN6: curl_setopt_array($curl, $optarray); goto WrFjy; W3TLS: curl_close($curl); goto OcFQz; GZynK: } public function getOnlineVersion() { goto kGGvS; o7xwD: foreach ($changelogData as $str) { goto XrvvI; qMppv: GPdl3: goto l8jcP; Fx0vY: switch ($type) { case "\x66\151\x78": array_push($changelog["\146\151\x78"], trim($Substr[1])); goto GPdl3; case "\x6e\145\167": array_push($changelog["\x6e\145\x77"], trim($Substr[1])); goto GPdl3; } goto vGpAH; vGpAH: xJ05j: goto qMppv; XrvvI: $Substr = explode("\72", $str); goto FNLZp; FNLZp: $type = strtolower(preg_replace("\x2f\55\57", '', $Substr[0])); goto Fx0vY; l8jcP: nltfA: goto r5c9n; r5c9n: } goto TOb0J; NfTgi: $changelogData = explode("\xa", $onlineVer->changelog); goto DThQm; DThQm: $version = $onlineVer->version; goto RSzYr; RSzYr: ztqTL: goto ajU9p; yUDJD: NNiCA: goto QRLlk; ajU9p: $changelog = array("\x6e\145\167" => array(), "\146\x69\x78" => array()); goto dPmg3; VAE7R: $onlineVer = $this->getOnline(); goto IN9gy; IN9gy: if (empty($onlineVer)) { goto ztqTL; } goto NfTgi; QRLlk: return array("\x76\x65\x72\163\151\157\x6e" => $version, "\x63\150\141\x6e\x67\x65\154\x6f\147" => $changelog); goto O1EqU; kGGvS: $version = ''; goto VAE7R; dPmg3: if (!(!empty($changelogData) && is_array($changelogData))) { goto NNiCA; } goto o7xwD; TOb0J: Gwzgh: goto yUDJD; O1EqU: } public function getCachedVersion() { goto lQ7h5; r6zj8: $parser = new \xml2Array(); goto Q4Gu_; czSCX: EPPNo: goto hINKQ; obVQn: $contents = file_get_contents("\160\150\x61\162\72\x2f\57" . $this->cached . "\x2f" . $this->moduleName . "\57\x6d\x6f\x64\165\154\145\56\170\155\x6c"); goto r6zj8; Q4Gu_: $xml = $parser->parseAdvanced($contents); goto czSCX; hINKQ: return isset($xml) ? $xml["\155\x6f\x64\165\x6c\145"]["\x76\145\x72\163\x69\157\156"] : "\60"; goto cfNBr; lQ7h5: if (!file_exists($this->cached)) { goto EPPNo; } goto obVQn; cfNBr: } public function getNewVersion() { goto NGyH_; MdfAM: $obj = get_object_vars($module); goto V1c0L; V1c0L: return $obj["\166\145\162\163\x69\157\156"]; goto iVZ0w; NGyH_: $module = simplexml_load_file($this->modulesDir . "\x2f" . $this->moduleName . "\x2f\x6d\x6f\144\x75\154\145\56\x78\155\x6c"); goto MdfAM; iVZ0w: } public function upgrade() { goto pn0Nn; nhI4c: return $this->getNewVersion(); goto OK8vP; pn0Nn: $phar = new \PharData($this->cached); goto QH9dQ; QH9dQ: $this->rrmdir($this->modulesDir . "\57" . $this->moduleName); goto KVe7a; KVe7a: $phar->extractTo($this->modulesDir, null, true); goto nhI4c; OK8vP: } function rrmdir($dir) { goto FPkyg; viXNz: $objects = scandir($dir); goto yhSJh; im9fS: rmdir($dir); goto Lg6xY; Lg6xY: WEBBD: goto qyWBc; yhSJh: foreach ($objects as $object) { goto UXO1R; Jy00c: ytuXS: goto X36Rt; eZarp: unlink($dir . DIRECTORY_SEPARATOR . $object); goto RusT7; RbOo5: rrmdir($dir . DIRECTORY_SEPARATOR . $object); goto d55FG; RusT7: goto wx5tC; goto ikyHj; UXO1R: if (!($object != "\56" && $object != "\x2e\x2e")) { goto wOvSp; } goto qoFJV; ikyHj: h6wWZ: goto RbOo5; QgK9Z: wOvSp: goto Jy00c; d55FG: wx5tC: goto QgK9Z; qoFJV: if (is_dir($dir . DIRECTORY_SEPARATOR . $object) && !is_link($dir . "\x2f" . $object)) { goto h6wWZ; } goto eZarp; X36Rt: } goto GYtv0; FPkyg: if (!is_dir($dir)) { goto WEBBD; } goto viXNz; GYtv0: bPgOD: goto im9fS; qyWBc: } }
