<?php
 namespace Informunity\Classes; use Informunity\Log; use Informunity\Rest\App\Call\CheckData; use Informunity\Rest\App\Call\Finish; use Informunity\Rest\App\Call\Register; class Offline { public $PID; public function __construct() { $this->PID = __DIR__ . "\x2f\56\x2e\57\x2e\x2e\57\x50\111\104"; } public function ProcessCall($config, $call) { goto U0aNm; g_0dN: $this->unsetPID(); goto PWzh3; sm66w: yhbx7: goto jTCkJ; fzWVD: $this->deleteCall($call["\143\141\x6c\154\x69\144"]); goto hasNL; U0aNm: $this->setPID(); goto THGC1; HLCYQ: xOB2X: goto fzWVD; cCBxm: if (!(!empty($call["\162\145\147\x69\163\164\145\162"]) && !empty($call["\x66\x69\x6e\x69\x73\x68"]))) { goto xOB2X; } goto kp2Ra; THGC1: $config["\141\x73\x74\x65\162\151\x73\153\137\x63\x61\154\154\x69\144"] = "\133\117\146\x66\114\151\x6e\145\135"; goto cCBxm; kp2Ra: $registerID = $this->RegisterCall($config, $call); goto HLCYQ; jTCkJ: Sf0j8: goto g_0dN; KNIPC: if (!$this->FinishCall($config, $call, $registerID)) { goto yhbx7; } goto AlAhK; hasNL: if (empty($call["\x66\151\x6e\151\163\150"])) { goto Sf0j8; } goto KNIPC; AlAhK: $this->deleteCall($call["\x63\141\154\154\x69\144"]); goto sm66w; PWzh3: } protected function RegisterCall($config, $call) { goto WI2FO; yAFyJ: $registerResult = Register::load($config, $reg)->Run(); goto QBztf; dGxXF: $registerResultParse2 = explode("\x2c", $registerResultParse[1]); goto xiG0q; kEXmA: $config["\114\151\143\x65\156\x73\145"] = new \Informunity\License(); goto ozPOQ; xiG0q: return $registerResultParse2[0]; goto Pa7IW; WI2FO: $reg[2] = json_decode($call["\x72\x65\x67\x69\x73\164\x65\x72"]); goto kEXmA; ozPOQ: $config["\114\151\x63\145\156\x73\x65"]->setData($config); goto yAFyJ; QBztf: $registerResultParse = explode("\x5e", $registerResult); goto dGxXF; Pa7IW: } protected function FinishCall($config, $call, $registerID = false) { goto kWqPR; Myceq: return false; goto W2F92; kAH55: $finish[0] = $registerID; goto vbq3O; TRJPz: if (!($registerID && Offline::isOfflineCallID($registerID))) { goto XdkDe; } goto X8_MF; X8_MF: Offline::SaveRequest("\146\151\x6e\151\x73\x68", implode("\54", $finish), $registerID); goto Myceq; kWqPR: $finish = explode("\x2c", json_decode($call["\146\151\156\151\x73\150"])); goto TRJPz; Ty_b1: $fin[2] = implode("\54", $finish); goto Wae1l; vbq3O: mblyp: goto Ty_b1; W2F92: XdkDe: goto EbePD; Wae1l: return Finish::load($config, $fin)->Run(); goto iejQT; EbePD: if (!$registerID) { goto mblyp; } goto kAH55; iejQT: } public static function SaveRequest($type, $data, $callid = '') { goto kBR9W; F3oyi: LqA1Y: goto H0Vlh; LazNm: $callid = static::makeCallID(); goto F3oyi; kBR9W: if (!($type === "\162\145\147\151\163\164\x65\162")) { goto LqA1Y; } goto LazNm; H0Vlh: $array = array("\143\x61\154\x6c\x69\144" => $callid, $type => json_encode($data)); goto Q7ATz; Dj8rg: return $callid; goto YFlwF; Q7ATz: IUDB::Insert("\151\165\142\x32\64\x5f\x6f\x66\146\154\x69\x6e\145", $array); goto Dj8rg; YFlwF: } public static function makeCallID() { goto vb04G; Qkmr8: return uniqid($prefix) . "\x2e" . $date->getTimestamp(); goto TFQvE; vb04G: $prefix = "\157\x66\x66\154\151\156\x65\x43\141\x6c\x6c\137"; goto HDbly; HDbly: $date = new \DateTime(); goto Qkmr8; TFQvE: } public static function isOfflineCallID($ID) { return preg_match("\x2f\x5e\157\x66\146\x6c\151\156\145\x43\141\x6c\x6c\x2f", $ID); } public function getCalls($limit = 0) { goto m8QoJ; Prj1X: $status = $q->fetchAll(\PDO::FETCH_ASSOC); goto DBY9d; LvahA: $q->execute(); goto Prj1X; JzzLK: $q = $db->prepare($sql); goto LvahA; m8QoJ: $db = \FreePBX::Database(); goto fMMU9; DBY9d: return is_array($status) ? $status : array(); goto wR3DK; tuGiq: N0g2T: goto JzzLK; fMMU9: $sql = "\123\105\114\x45\103\x54\40\52\40\106\122\x4f\115\x20\151\x75\142\62\64\137\x6f\x66\x66\x6c\x69\156\x65"; goto vTSTA; vTSTA: if (!$limit) { goto N0g2T; } goto qjriS; qjriS: $sql .= "\x20\114\x49\115\x49\124\40" . $limit; goto tuGiq; wR3DK: } private function deleteCall($id) { goto NplOn; FxuLa: $q->execute(); goto gKn2j; gKn2j: return true; goto EdnEf; JqExY: $sql = "\x44\x65\x6c\x65\164\145\40\106\122\117\x4d\40\151\x75\x62\x32\64\137\157\x66\146\x6c\x69\x6e\x65\40\x57\x48\105\122\x45\40\143\x61\154\x6c\x69\x64\x3d\72\x63\141\154\x6c\151\144"; goto NTFsh; NTFsh: $q = $db->prepare($sql); goto A4Bby; NplOn: $db = \FreePBX::Database(); goto JqExY; A4Bby: $q->bindParam("\x3a\x63\141\x6c\154\151\x64", $id, \PDO::PARAM_STR); goto FxuLa; EdnEf: } private function setPID() { file_put_contents(__DIR__ . "\x2f\x2e\x2e\57\56\56\57\x50\x49\x44", ''); } private function unsetPID() { unlink(__DIR__ . "\57\x2e\x2e\x2f\x2e\x2e\57\120\x49\x44"); } public function CheckPID() { goto P9aH9; o4itx: if (!(fileatime($this->PID) + 120 > $date->getTimestamp())) { goto T9DBo; } goto KxGbj; VQ9_t: return false; goto ecbK3; lZuhP: vtmfD: goto leJD8; r4GDe: return false; goto lZuhP; KxGbj: return true; goto YJJVp; o_NcV: $this->unsetPID(); goto VQ9_t; YJJVp: T9DBo: goto o_NcV; P9aH9: if (file_exists($this->PID)) { goto vtmfD; } goto r4GDe; leJD8: $date = new \DateTime(); goto o4itx; ecbK3: } }
