<?php
 namespace Informunity\Classes; use FreePBX\modules\Iub24; use Informunity\Log; class Addon { protected $cachePath; protected $destDir; protected $enabled; protected $errorNoFiles = array("\155\163\x67\x73" => array("\x74\171\x70\x65" => "\145\162\x72\x6f\162", "\164\x65\x78\164" => "\156\157\x20\x66\151\x6c\x65\x73")); protected $errorCantUntar = array("\155\x73\147\x73" => array("\x74\x79\160\145" => "\145\x72\162\x6f\162", "\x74\x65\x78\x74" => "\103\x61\156\x27\164\40\125\156\164\141\x72")); protected $errorUnsupported = array("\155\163\x67\x73" => array("\x74\171\x70\145" => "\145\162\x72\x6f\162", "\x74\145\x78\x74" => "\x55\x6e\x73\x75\160\x70\x6f\x72\164\x65\144\x20\141\144\x64\157\x6e")); protected $errorAddonLocation = array("\x6d\x73\x67\x73" => array("\x74\171\x70\x65" => "\x65\x72\x72\157\162", "\164\x65\170\x74" => "\101\144\144\x6f\x6e\40\x6c\157\143\141\164\151\x6f\156\40\156\157\x74\40\163\x65\x74")); protected $done; protected $config; public static function load($config) { return new Addon($config); } public function __construct($config) { goto Hlgb1; pbrZO: $this->cachePath = realpath($amp_conf["\101\x4d\120\127\105\x42\122\x4f\x4f\124"] . "\x2f\141\144\x6d\x69\x6e\57\155\157\144\x75\x6c\145\x73\x2f\x5f\143\x61\143\150\145"); goto JUL2k; cBS0o: $this->enabled = $this->config["\141\144\x64\x6f\156"]; goto pbrZO; Hlgb1: $this->config = $config; goto P8j2N; P8j2N: global $amp_conf; goto cBS0o; JUL2k: $this->done = array("\x61\143\x74\x69\x6f\x6e\163" => array("\125\x70\147\162\x61\144\145\x4d\x6f\144\165\x6c\145"), "\157\160\164\151\157\x6e\163" => array("\x55\x70\x67\162\x61\x64\x65\115\157\144\165\x6c\145" => array("\x6d\157\x64\x75\154\145\x73" => array("\x69\x75\x62\62\x34" => array("\x61\x63\x74\151\157\x6e" => "\x69\156\163\164\x61\154\x6c", "\x74\x72\141\143\153" => "\163\x74\x61\142\x6c\x65", "\166\x65\x72\163\151\157\x6e" => $config["\x76\x65\162\x73\x69\x6f\156"]))))); goto XYdC9; d_200: $this->destDir = $settings["\143\157\156\x66\x5f\144\151\162"]; goto lA2Ir; XYdC9: $settings = Iub24::getSettings(); goto d_200; lA2Ir: } public function install($FILES) { goto BTt27; BTt27: if (!(empty($this->destDir) || $this->destDir == false)) { goto BNmct; } goto Ue3Zq; eHZof: Ct8c9: goto YP7GB; pDol3: foreach ($FILES as $file) { goto UC1dm; uAcEH: if ($this->checkCompatability($tempDir)) { goto DmIDr; } goto IGUTD; Whx90: if ($this->untar($tempFile, $tempDir)) { goto EgHhy; } goto AOVTN; iM1fz: return $this->errorNoFiles; goto sYQ8Q; kYL1C: return $this->errorCantUntar; goto noTNk; noTNk: a10Td: goto DjKrt; AOVTN: return $this->errorCantUntar; goto DQg4x; nkYFY: $this->remove($tempDir); goto crEA6; ZTshR: goto QiisR; goto osoym; mNVNp: $tempDir = $this->prepareTempDir($file["\164\x6d\160\x5f\156\x61\155\145"]); goto Whx90; vwxIB: if (!$this->untar($tempFile, $this->destDir)) { goto LjAQc; } goto v3t6a; IGUTD: return $this->errorUnsupported; goto ZTshR; hSZqL: $this->approveAddon(1); goto lOoRj; x0TGs: $this->remove($tempFile); goto MegL5; osoym: DmIDr: goto hSZqL; U0i8P: Kef1U: goto vwxIB; crEA6: if (empty($this->destDir)) { goto Kef1U; } goto gSfvt; sYQ8Q: gPXam: goto mNVNp; DQg4x: EgHhy: goto uAcEH; o3z2c: LjAQc: goto kYL1C; lOoRj: QiisR: goto nkYFY; gSfvt: $this->remove($this->destDir . "\52"); goto U0i8P; UC1dm: $tempFile = $this->cachePath . "\x2f" . $file["\156\x61\155\x65"]; goto x0TGs; MegL5: if (move_uploaded_file($file["\164\155\160\x5f\156\x61\155\145"], $tempFile)) { goto gPXam; } goto iM1fz; v3t6a: return $this->done; goto o3z2c; DjKrt: } goto eHZof; zpKlm: BNmct: goto O0N32; Ue3Zq: return $this->errorAddonLocation; goto zpKlm; O0N32: if (!(empty($FILES) || !is_array($FILES))) { goto U0rzN; } goto I23JP; I23JP: return $this->errorNoFiles; goto L8YSQ; L8YSQ: U0rzN: goto pDol3; YP7GB: } public function uninstall() { goto UeZFD; aD0n1: return $this->done; goto NIpZU; GNg1t: $this->remove($this->destDir . "\52"); goto yE1Y0; UeZFD: $this->approveAddon(0); goto gmzxC; gmzxC: if (empty($this->destDir)) { goto n54ST; } goto GNg1t; yE1Y0: n54ST: goto aD0n1; NIpZU: } public function getInfo() { goto ET_4A; Na7YD: try { goto fY3Jd; wBZ_h: $supportedApp["\x73\165\x70\160\157\162\164\145\x64\x41\x70\x70"] = $this->compare($info); goto LWG0g; fY3Jd: $info = json_decode($data, true); goto wBZ_h; LWG0g: $result = array_merge($result, $info, $supportedApp); goto tXaJZ; tXaJZ: } catch (\Exception $exception) { return $result; } goto KSLaQ; QSH03: $result["\145\170\151\163\164\x73"] = !empty($dir); goto Lh8CB; k74TP: $dir = glob($this->destDir . "\x2a"); goto QSH03; l1eTp: $data = file_get_contents($infoFile); goto Na7YD; KSLaQ: return $result; goto ClraN; LHqhn: return $result; goto ip2vj; ET_4A: $result["\145\156\x61\142\154\145\144"] = $this->enabled; goto svmUW; ip2vj: QucUh: goto l1eTp; svmUW: $infoFile = $this->destDir . "\57\111\156\x66\157\x72\155\x75\x6e\x69\164\x79\57\141\x64\x64\x6f\156\56\152\x73\x6f\156"; goto k74TP; Lh8CB: if (file_exists($infoFile)) { goto QucUh; } goto LHqhn; ClraN: } protected function prepareTempDir($tempFile) { goto ZxJuy; NbmIU: return $exitcode == 0 ? $tempDir : false; goto inzu_; CJ2p2: q59fP: goto egflf; shOoW: if (!file_exists($tempDir)) { goto q59fP; } goto h6p41; h6p41: $this->remove($tempDir); goto CJ2p2; egflf: exec("\57\165\163\x72\57\x62\x69\x6e\x2f\145\156\x76\40\155\x6b\x64\x69\x72\x20" . $tempDir, $output, $exitcode); goto xGr6B; ZxJuy: $tempDir = $this->cachePath . "\x2f" . basename($tempFile); goto shOoW; xGr6B: unset($output); goto NbmIU; inzu_: } protected function untar($file, $dir) { goto UFxQK; WMgAU: return $exitcode == 0; goto K7TYj; Bl10Q: exec($cmd, $output, $exitcode); goto tjxGY; tjxGY: unset($output); goto WMgAU; UFxQK: $cmd = "\x2f\165\163\x72\57\142\x69\x6e\x2f\x65\156\166\x20\164\141\162\40\170\x66\40" . escapeshellarg($file) . "\40\55\x43\40" . escapeshellarg($dir) . "\40\x2d\55\x73\164\162\151\160\55\x63\157\155\160\x6f\x6e\145\x6e\x74\x73\x20\x31"; goto Bl10Q; K7TYj: } protected function checkCompatability($tempDir) { goto ijcy8; UWRUc: return false; goto ovegQ; z4AiE: if (file_exists($filename)) { goto wlPFj; } goto UWRUc; MydgT: $data = file_get_contents($filename); goto a8PDW; a8PDW: try { $dataDecoded = json_decode($data, true); return $this->compare($dataDecoded); } catch (\Exception $exception) { return false; } goto lG13S; ijcy8: $filename = $tempDir . "\x2f\x49\x6e\x66\157\162\x6d\165\156\151\164\x79\57\x61\144\144\157\156\56\x6a\163\157\156"; goto z4AiE; ovegQ: wlPFj: goto MydgT; lG13S: } protected function compare($addonData) { goto UKDM0; IqYyh: nDkVR: goto pRaBU; pRaBU: a517S: goto NmR_v; MOZKu: if (isset($addonData["\141\x70\x70"])) { goto nDkVR; } goto VFEW_; o2pwm: if (!version_compare_freepbx($this->config["\141\x64\144\157\156\126\x65\162\163\151\x6f\x6e"], $addonData["\141\160\x70"], "\x3e")) { goto jh4xj; } goto IxCyf; VFEW_: return false; goto IqYyh; UKDM0: if (!$addonData) { goto a517S; } goto MOZKu; NLLn0: Brrgl: goto o2pwm; x50zA: return true; goto Og0DF; tqnng: return false; goto NLLn0; RTeuN: jh4xj: goto x50zA; NmR_v: if (!version_compare_freepbx($this->config["\x76\145\x72\x73\x69\x6f\156"], $addonData["\141\160\160"], "\74")) { goto Brrgl; } goto tqnng; IxCyf: return false; goto RTeuN; Og0DF: } protected function approveAddon($value) { IUDB::Insert("\x69\x75\142\x32\x34", array("\x61\144\144\x6f\156" => $value)); } protected function remove($dir) { goto j1gTo; Jl3h9: HsA6h: goto Z6Oz6; j1gTo: if (!file_exists(dirname($dir))) { goto HsA6h; } goto a0BMB; a0BMB: exec("\57\x75\x73\x72\57\142\x69\x6e\57\145\156\166\x20\x72\x6d\x20\x2d\x72\x66\x20" . $dir); goto Jl3h9; Z6Oz6: } }
