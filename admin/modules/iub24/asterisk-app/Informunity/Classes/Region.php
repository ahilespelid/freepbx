<?php
 namespace Informunity\Classes; use Informunity\Log; class Region { private $urls; private $count = 0; private $tmpdir; public function __construct($moduleConfig) { goto MQ23C; RSyU1: EGBmY: goto bWdCU; MQ23C: $this->tmpdir = $moduleConfig["\146\151\x6c\145"]["\x65\170\160\x6f\x72\164\x52\x65\x67\x69\x6f\156"]; goto LZ2H2; cVafo: $this->urls = $moduleConfig["\x52\145\147\151\x6f\x6e\125\x72\x6c"]; goto RSyU1; LZ2H2: if (!empty($this->urls)) { goto EGBmY; } goto cVafo; bWdCU: } public static function load($moduleConfig) { return new Region($moduleConfig); } public function getRegionFiles() { goto ZN2ff; D9FBj: d1FQs: goto cgUvi; FhSlR: $my_save_dir = $amp_conf["\x41\x4d\120\x57\x45\102\122\x4f\117\x54"] . $this->tmpdir; goto kz3u_; ZN2ff: global $amp_conf; goto dOYoy; AEtkx: $this->urls = array(); goto FhSlR; gStTY: if ($this->count <= 3) { goto d1FQs; } goto TqEJZ; qEsyA: RvJ_i: goto gStTY; b3j4j: ogvHi: goto vlhjh; XiDn5: return $this->getRegionFiles(); goto b3j4j; kz3u_: if (is_dir($my_save_dir)) { goto n3cMv; } goto XjShW; rCSEk: n3cMv: goto d2LZZ; RwgON: return true; goto qEsyA; ct7LR: goto ogvHi; goto D9FBj; d2LZZ: foreach ($urlArray as $url) { goto foLB3; mEKze: $curl = curl_init($url); goto Tv78i; V2vQb: $error = curl_error($curl); goto QT7Yr; h_qi8: $file = fopen($complete_save_loc, "\167\53"); goto Wpcx8; iRK4W: array_push($this->urls, $url); goto qHIXO; M9Fo1: fclose($file); goto itUf0; QT7Yr: curl_close($curl); goto M9Fo1; Wpcx8: $opt = array(CURLOPT_FILE => $file, CURLOPT_FOLLOWLOCATION => true, CURLOPT_CONNECTTIMEOUT => 10, CURLOPT_TIMEOUT => 90, CURLOPT_VERBOSE => false, CURLOPT_HEADER => false, CURLOPT_SSL_VERIFYPEER => false); goto mEKze; jv1Hd: $complete_save_loc = $my_save_dir . $filename; goto h_qi8; itUf0: if (!$error) { goto YPJ8n; } goto iRK4W; cX1Sy: curl_exec($curl); goto V2vQb; r6D1i: Bu12z: goto iOkaM; Tv78i: curl_setopt_array($curl, $opt); goto cX1Sy; foLB3: $filename = basename($url); goto jv1Hd; qHIXO: YPJ8n: goto r6D1i; iOkaM: } goto iOrTN; vlhjh: IaaBZ: goto FPaIE; FPaIE: return false; goto WzJeV; iOrTN: Rp6UQ: goto vWqEv; MntVJ: $urlArray = $this->urls; goto AEtkx; cgUvi: $this->count++; goto XiDn5; dOYoy: if (!is_array($this->urls)) { goto IaaBZ; } goto MntVJ; vWqEv: if (!empty($this->urls)) { goto RvJ_i; } goto RwgON; XjShW: mkdir($my_save_dir); goto rCSEk; TqEJZ: return false; goto ct7LR; WzJeV: } public function DoDownloadFiles() { goto VrAKy; R8oYY: J1IGy: goto tjHHg; YP_ze: global $amp_conf; goto A2Ow8; jPJ7m: foreach ($this->urls as $url) { goto NlFVC; NlFVC: $filePath = $path . basename($url); goto NA3_p; myLI8: return true; goto dItF9; ytb8i: LqoLi: goto UHI7k; nvVEk: if (!($d->getTimestamp() - filemtime($filePath) >= 2592000)) { goto jc2FP; } goto sNxjS; dItF9: rzRQe: goto aVh6t; NA3_p: if (file_exists($filePath)) { goto rzRQe; } goto myLI8; sNxjS: return true; goto oxz3J; aVh6t: if (!(filesize($filePath) === 0)) { goto mDnEW; } goto x9aTb; yuWEh: $d = new \DateTime(); goto nvVEk; sMXjt: mDnEW: goto yuWEh; x9aTb: return true; goto sMXjt; oxz3J: jc2FP: goto ytb8i; UHI7k: } goto R8oYY; XQ1bh: return false; goto yralP; A2Ow8: $path = $amp_conf["\x41\115\x50\x57\105\x42\122\117\x4f\124"] . $this->tmpdir; goto jPJ7m; tjHHg: P7vE1: goto XQ1bh; VrAKy: if (!(!empty($this->urls) && is_array($this->urls))) { goto P7vE1; } goto YP_ze; yralP: } public function createRegionList() { goto TDBiJ; bAOuB: foreach ($files as $csvFile) { Region::extract($csvFile); an127: } goto FxCUk; FqjJ2: $Log->toFile("\x46\x69\156\151\x73\x68\40\x46\151\x6c\x6c\151\156\147"); goto t1H5j; TDBiJ: $Log = new Log(array("\150\145\141\144\x65\162" => "\x55\160\x64\141\x74\151\156\x67\40\122\x65\147\151\x6f\156\163", "\141\x73\164\145\162\x69\x73\x6b\137\x63\141\154\154\151\144" => "\122\x65\154\157\141\144\151\156\x67\56\56\56")); goto DGqfO; EfUzN: return false; goto ojSI1; PR7fY: static::CreateDB(); goto ti1_7; DGqfO: global $amp_conf; goto McGk8; ojSI1: s_ASc: goto PR7fY; uoTCt: $files = glob($path . "\x2a\x2e\143\163\166"); goto Tbpat; FxCUk: o26Zr: goto FqjJ2; Tbpat: if ($this->filesExists($files)) { goto s_ASc; } goto EfUzN; McGk8: $path = $amp_conf["\x41\115\120\x57\105\x42\x52\x4f\117\x54"] . $this->tmpdir; goto uoTCt; ti1_7: $Log->toFile("\106\151\154\x6c\151\156\147\x20\x44\102\56\x2e\56"); goto bAOuB; t1H5j: } private function filesExists($filePaths) { goto QuLZW; QuLZW: if (!(!empty($filePaths) && is_array($filePaths))) { goto Rpvrt; } goto pklXv; jKrNz: Rpvrt: goto FgyvR; pklXv: foreach ($filePaths as $file) { goto F3KGs; lDuHe: return true; goto HUrpW; Frq5Q: zRt9Y: goto LQ52D; HUrpW: mb7vW: goto Frq5Q; F3KGs: if (!filesize($file)) { goto mb7vW; } goto lDuHe; LQ52D: } goto bmLcV; bmLcV: RYztU: goto jKrNz; FgyvR: } public static function createRow($data) { goto MDbB9; GiSZK: return "\50\x27" . $str[0] . "\x27\x2c\47" . $str[1] . "\47\x2c\47" . $str[2] . "\x27\51"; goto Bsl3z; OSaOd: $str[] = $data[0] . $data[2]; goto DZQa1; MDbB9: $str[] = $data[0] . $data[1]; goto OSaOd; DZQa1: $str[] = $data[5]; goto GiSZK; Bsl3z: } public static function insertRows($row) { goto Nh39j; eDorG: $addRegions = "\x49\x4e\x53\x45\122\x54\x20\111\x4e\124\117\40\x69\165\142\62\x34\137\x72\145\147\x69\157\x6e" . $strTableFields . "\x20\x56\x41\x4c\125\105\x53\x20" . $strDataReg; goto UzREB; wKUkG: $strDataReg = implode("\x2c\40", $row); goto eDorG; Z_8BG: $strTableFields = "\x28\140\156\165\x6d\142\x65\x72\137\146\162\x6f\155\140\x2c\x20\x60\156\165\155\x62\145\x72\137\165\x6e\x74\151\x6c\x60\54\40\140\x72\145\147\x69\x6f\x6e\140\x29"; goto wKUkG; UzREB: $DB->query($addRegions); goto PcOta; Nh39j: $DB = \FreePBX::Database(); goto Z_8BG; PcOta: } public static function CreateDB() { goto qKzkV; USi65: $sqlDrop = "\104\x52\117\x50\40\x54\101\102\114\105\x20\x49\106\x20\105\x58\x49\x53\x54\x53\40\x60\151\165\x62\x32\x34\137\x72\x65\x67\151\157\156\x60"; goto dTYC3; dTYC3: $DB->query($sqlDrop); goto BEdtc; qXwOu: $DB->query($sqlCreate); goto uw25G; qKzkV: $DB = \FreePBX::Database(); goto USi65; BEdtc: $sqlCreate = "\103\x52\105\x41\124\105\x20\x54\101\x42\x4c\x45\40\x60\151\165\142\x32\64\x5f\162\x65\147\151\x6f\x6e\x60\40\x28\xa\x20\x20\x20\x20\40\x20\x20\x20\40\40\40\40\x20\40\40\x20\40\40\x20\40\x20\40\40\x20\40\40\40\40\140\151\x64\x60\x20\111\x4e\x54\50\x32\x35\x35\x29\x20\101\x55\124\x4f\x5f\x49\116\x43\122\x45\115\x45\116\124\x20\120\122\x49\115\x41\x52\x59\x20\x4b\105\x59\x2c\xa\x20\x20\40\40\40\40\40\x20\x20\40\x20\40\40\x20\40\40\40\x20\x20\40\x20\x20\x20\40\40\40\x20\40\140\156\x75\155\142\145\162\137\146\162\157\x6d\140\x20\126\x41\122\x43\110\x41\x52\x28\x32\65\x35\51\54\12\40\x20\40\40\40\x20\40\40\40\40\x20\40\x20\x20\x20\40\40\40\40\x20\40\x20\x20\40\40\x20\x20\x20\x60\156\x75\155\x62\145\x72\x5f\x75\x6e\x74\x69\x6c\x60\x20\126\101\122\x43\110\101\x52\x28\x32\65\65\51\x2c\12\40\x20\40\x20\x20\40\x20\x20\40\40\40\40\x20\x20\40\x20\40\40\40\40\x20\40\x20\40\40\x20\x20\40\x60\x72\x65\147\x69\157\156\x60\40\x56\101\x52\103\110\101\122\x28\62\x35\65\x29\xa\40\x20\x20\x20\x20\40\40\x20\40\x20\40\40\x20\x20\x20\x20\x20\x20\40\40\40\40\40\x20\x20\40\40\x20\51\x20\105\x4e\x47\111\116\x45\75\111\x6e\x6e\157\x44\102\x20\104\105\106\x41\125\x4c\x54\x20\103\x48\x41\122\123\x45\x54\x3d\x75\164\x66\70\40\103\x4f\x4c\x4c\101\x54\105\75\165\164\146\70\x5f\x75\x6e\151\143\x6f\x64\145\x5f\143\x69"; goto qXwOu; uw25G: } public function getRegionByPhone($phoneNumber) { goto WqTWg; XZmfc: kplPK: goto O0QDE; Xc_eJ: fHJj4: goto yDg5o; miGMp: if (!empty($arDataRegion)) { goto kplPK; } goto gsTVk; HXRm1: try { $sqlReg->execute(); } catch (\Exception $e) { return false; } goto dA1dG; PccOH: if (!(iconv_strlen($phoneNumber) == 10)) { goto GAzwf; } goto WxEOc; gsTVk: return false; goto FM4eH; xhqFE: $sqlReg = $db->prepare($sqlSelect); goto Vw__6; FM4eH: goto fHJj4; goto XZmfc; WxEOc: $db = \FreePBX::Database(); goto aCdDQ; dA1dG: $arDataRegion = $sqlReg->fetchAll(\PDO::FETCH_ASSOC); goto miGMp; yDg5o: GAzwf: goto i7ccn; aCdDQ: $sqlSelect = "\x53\x45\114\x45\x43\x54\40\52\40\x46\x52\117\x4d\40\x60\x69\x75\142\x32\x34\x5f\162\145\x67\151\157\x6e\140\40\127\x48\105\122\x45\40\72\x70\x68\x6f\x6e\x65\x4e\165\155\x62\40\102\105\124\127\105\105\x4e\x20\140\x6e\x75\x6d\x62\x65\162\x5f\x66\162\x6f\x6d\140\40\x41\116\x44\40\140\x6e\x75\x6d\x62\x65\x72\x5f\x75\156\164\151\x6c\x60"; goto xhqFE; Vw__6: $sqlReg->bindParam("\72\160\150\x6f\156\x65\x4e\165\x6d\142", $phoneNumber, \PDO::PARAM_STR); goto HXRm1; WqTWg: $phoneNumber = trim($phoneNumber); goto PccOH; O0QDE: return $arDataRegion[0]["\x72\145\x67\151\x6f\156"]; goto Xc_eJ; i7ccn: } public function addRegionInLeadBx24($rest, $id, $phoneNumber) { goto ggFmH; v5GW0: ObFYC: goto KxxUL; yzEDA: $rest->query("\143\x72\x6d\56\154\145\141\144\56\x75\x70\144\141\x74\145", array("\151\144" => $id, "\146\151\x65\154\144\x73" => array("\x41\104\x44\x52\105\x53\123\137\122\x45\107\x49\117\116" => $region))); goto DT2Ym; vifFy: $region = $this->getRegionByPhone($phoneNumber); goto WN8pl; ggFmH: if (!($id > 0)) { goto ObFYC; } goto vifFy; WN8pl: if (!$region) { goto L8TUY; } goto yzEDA; DT2Ym: L8TUY: goto v5GW0; KxxUL: } public static function addRegions() { goto RfSsx; ySr7L: $cron->add($cron_line); goto g1xzs; RfSsx: $cron = \FreePBX::Cron(); goto MaxP5; MaxP5: $cron_line = "\100\x64\141\151\x6c\171\x20" . fpbx_which("\x66\167\x63\157\x6e\163\x6f\x6c\x65") . "\40\x69\165\40\x75\162"; goto XjRBb; g1xzs: Y1vkb: goto GJMu1; XjRBb: if ($cron->checkLine($cron_line)) { goto Y1vkb; } goto ySr7L; GJMu1: } public static function deleteRegions() { goto uWcjy; lk6MI: qEJmh: goto XHCbV; WR5vF: if (empty($cron_lines)) { goto qEJmh; } goto lk6MI; iBsHS: $cron_lines = $cron->getAll(); goto WR5vF; wyRsz: $cron = \FreePBX::Cron(); goto iBsHS; XHCbV: foreach ($cron_lines as $cron_line) { goto m3S1t; w02fL: zKLHr: goto GhO9U; fbLXs: aiKVq: goto w02fL; xRm1A: $cron->removeLine($cron_line); goto fbLXs; m3S1t: if (!strpos($cron_line, "\146\167\143\157\156\163\157\x6c\145\40\151\165\40\x75\162")) { goto aiKVq; } goto xRm1A; GhO9U: } goto C4Yed; C4Yed: b8NQD: goto tWofx; uWcjy: $db = \FreePBX::Database(); goto wyRsz; WvpjX: $db->query($drop); goto fResT; tWofx: $drop = "\x44\x52\x4f\120\x20\x54\x41\x42\114\x45\x20\111\106\40\x45\130\x49\123\124\123\x20\140\151\165\x62\x32\64\x5f\162\145\x67\151\157\x6e\x60"; goto WvpjX; fResT: } public static function extract($file) { goto EZWaZ; gXWuH: sPu3C: goto YVf5C; OjtI4: trSDH: goto C8WFi; EYliH: $i = 0; goto fk9W5; dzD_6: $arRegions[] = $row; goto piLnv; wMPNc: AnTan: goto DBLtW; uX3KQ: cyQuF: goto eTg16; ZAPxZ: Region::insertRows($arRegions); goto anDbU; EZWaZ: $csv = fopen($file, "\x72"); goto xiypQ; YVf5C: if (!(count($arRegions) > 0)) { goto trSDH; } goto LXo8z; xiypQ: $arRegions = array(); goto EYliH; C3Rsd: $i++; goto Q79P1; eUIIE: QCV1L: goto KR4Zy; HEE5x: $arRegions[] = array(); goto OjtI4; uyQuF: if (!strlen($row)) { goto z5pk7; } goto dzD_6; eTg16: goto QCV1L; goto gXWuH; Q79P1: if (!($i === 1)) { goto Q2Ugw; } goto obrik; anDbU: $arRegions = array(); goto uX3KQ; fk9W5: if (!($csv !== FALSE)) { goto AnTan; } goto eUIIE; OI3Hi: if (!(count($arRegions) >= 100)) { goto cyQuF; } goto ZAPxZ; LXo8z: Region::insertRows($arRegions); goto HEE5x; C8WFi: fclose($csv); goto wMPNc; KR4Zy: if (!(($data = fgetcsv($csv, 2000, "\x3b")) !== FALSE)) { goto sPu3C; } goto C3Rsd; piLnv: z5pk7: goto OI3Hi; DmatL: Q2Ugw: goto xXgfD; obrik: goto QCV1L; goto DmatL; xXgfD: $row = self::createRow($data); goto uyQuF; DBLtW: } }
