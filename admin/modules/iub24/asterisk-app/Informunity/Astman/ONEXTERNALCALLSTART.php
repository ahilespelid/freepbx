<?php
 namespace Informunity\Astman; use Informunity\Classes\Lines; use Informunity\Log; use Informunity\Rest\App\Users\GetPhone; class ONEXTERNALCALLSTART { protected $config; protected $astman; protected $Log; protected $arData; protected $extension; protected $timestamp; protected $destination; protected $callerID; protected $LINE_NUMBER; protected $USER_ID; protected $CALL_ID; protected $ExtraNumber; public static function Load($config) { return Custom::GetCustomData($config, __CLASS__); } public function __construct($config) { goto xghtp; hjToz: $this->astman = $astman; goto OA7C4; xXxEF: $this->config = $config; goto hjToz; xghtp: global $astman; goto xXxEF; OA7C4: } public function Run($arData) { goto lb2QJ; dtld1: if (!($this->wrongLineNumber() || $this->emptyExtension())) { goto FKdtW; } goto GbA56; MUY6G: FKdtW: goto cKH_x; lb2QJ: $this->Log = new Log(array("\x68\145\x61\x64\x65\x72" => "\x52\145\161\165\x65\x73\x74\40\146\x72\x6f\x6d\40\102\151\164\162\x69\170\40", "\x61\163\x74\145\162\x69\163\x6b\137\143\141\154\154\x69\x64" => "\133\117\x4e\x45\130\x54\105\122\116\x41\x4c\103\x41\114\114\x53\124\101\122\x54\x5d"), $this->config["\x6c\157\x67\x67\151\x6e\x67"]); goto GJiEk; vlxkW: $status = $this->astman->originate($command); goto GyAHd; DUuSP: $this->callerID = preg_replace("\57\x28\77\41\136\x5c\53\x29\x5c\x44\53\57", '', $arData["\x64\141\164\141"]["\120\110\x4f\x4e\x45\x5f\116\x55\x4d\102\105\x52"]); goto WEWw9; gdvqp: if (!$this->noRoute()) { goto vPpxH; } goto w76Ul; ZRcBU: aE6A5: goto tERDG; y3j6I: $this->LINE_NUMBER = $arData["\144\x61\164\141"]["\114\x49\x4e\x45\137\116\x55\x4d\102\105\x52"]; goto DUuSP; knNLh: $this->CALL_ID = $arData["\144\x61\x74\x61"]["\103\x41\114\114\137\111\x44"]; goto n3YNx; GyAHd: if (!$this->errorStatus($status)) { goto aE6A5; } goto N9BGI; WjFKD: $this->astman->database_put("\x49\125\102\x32\x34\57\103\62\103", $this->CALL_ID, $this->timestamp); goto vlxkW; cKH_x: $this->setDestination(); goto gdvqp; Rm3Wd: $this->arData = $arData; goto knNLh; BLP8I: $command = $this->getCommand(); goto WjFKD; n3YNx: $this->USER_ID = $arData["\144\141\164\x61"]["\x55\123\x45\122\137\111\x44"]; goto y3j6I; GJiEk: $this->Log->toFile($arData); goto Rm3Wd; GbA56: return C2CFail::Load($this->config)->Run($this->CALL_ID, $this->USER_ID); goto MUY6G; N9BGI: return C2CFail::Load($this->config)->Run($this->CALL_ID, $this->USER_ID); goto ZRcBU; w76Ul: return C2CFail::Load($this->config)->Run($this->CALL_ID, $this->USER_ID); goto uFgd8; MqIXa: jeZxK: goto dtld1; WEWw9: $this->ExtraNumber = !empty($arData["\x64\141\x74\x61"]["\105\x58\124\x45\x4e\123\x49\117\x4e"]) ? $arData["\x64\x61\x74\141"]["\105\x58\x54\105\x4e\123\111\117\x4e"] : ''; goto QUnuA; uFgd8: vPpxH: goto BLP8I; tERDG: return "\x73\x75\x63\x63\145\x73\163"; goto aMFFy; QUnuA: if (!$this->inCall()) { goto jeZxK; } goto GXv5W; GXv5W: return "\146\x61\x69\154"; goto MqIXa; aMFFy: } protected function getCommand() { return array("\103\150\141\156\156\x65\154" => "\114\157\143\141\154\57" . $this->extension . "\x40\146\x72\x6f\155\55\143\154\151\143\x6b\x74\x6f\143\141\154\154\55\x63\x61\x6c\154\x65\162\57\x6e", "\x41\160\x70\x6c\x69\143\x61\164\151\157\x6e" => "\x44\x69\141\154", "\104\x61\x74\x61" => "\x4c\x6f\143\141\154\x2f" . $this->destination . "\x40\146\x72\x6f\x6d\55\151\156\164\145\162\x6e\141\154", "\101\163\x79\156\x63" => 0, "\103\141\x6c\154\x65\162\x49\x44" => $this->callerID, "\126\141\162\151\x61\x62\x6c\145" => "\137\x5f\102\62\64\137\x55\123\105\x52\x5f\111\x44\x3d" . $this->USER_ID . "\x2c\103\114\111\x43\113\x54\x4f\103\x41\114\x4c\x3d" . $this->callerID . "\54" . "\x5f\137\x42\62\x34\x5f\x43\101\x4c\114\x5f\x49\104\75" . $this->CALL_ID . "\54\137\x5f\x53\110\x4f\x57\137\x43\x41\x52\104\x3d\61\54\x5f\137\103\x4c\111\103\113\105\x52\x3d" . $this->extension . "\x2c\137\x5f\104\124\x4d\106\137\x4f\x4e\137\x41\x4e\123\x57\x45\122\x3d\127\x57\x57" . $this->ExtraNumber); } protected function inCall() { goto xBAPK; xBAPK: $delay = 3600; goto YfJy5; gPINf: $inCall = $this->astman->database_get("\x49\125\102\x32\64\57\103\62\103", $this->CALL_ID) + $delay > $this->timestamp; goto t462l; YfJy5: $date = new \DateTime(); goto tReVg; E8inh: return $inCall; goto R9qnj; t462l: if (!$inCall) { goto rau3O; } goto lOQJk; tReVg: $this->timestamp = $date->getTimestamp(); goto gPINf; CT8Dq: rau3O: goto E8inh; lOQJk: $this->Log->toFile("\124\x68\x69\163\40\x63\141\x6c\x6c\x20\141\154\x72\145\144\x79\40\x70\162\157\x63\145\x73\x73\145\x64"); goto CT8Dq; R9qnj: } protected function wrongLineNumber() { goto D1sgx; kUre2: $this->Log->toFile("\127\122\117\x4e\107\x20\114\151\156\145\x3a\x20" . $this->LINE_NUMBER); goto Lyeck; D1sgx: $wrong = !empty($this->LINE_NUMBER) && !Lines::load()->checkLinesByNumber($this->LINE_NUMBER); goto hJzR3; hJzR3: if (!$wrong) { goto VdWIE; } goto kUre2; Lyeck: VdWIE: goto EszLa; EszLa: return $wrong; goto xqKxB; xqKxB: } protected function emptyExtension() { goto WQtzC; acaDt: ImQ_u: goto VqrZj; k_VNM: $this->Log->toFile("\x21\105\130\124\x45\116\x53\111\117\116\x20\116\x4f\124\x20\106\117\125\x4e\104\x21"); goto jyHlh; LJvQF: goto ImQ_u; goto Dd9jZ; jyHlh: QUZTI: goto ulNEc; vcqeg: if (empty($this->extension)) { goto Z1WQw; } goto aN6cj; ulNEc: return empty($this->extension); goto ZNZ04; WQtzC: $this->extension = $this->astman->database_get("\x49\125\102\x32\x34", $this->USER_ID . "\57\120\110\x4f\x4e\105"); goto vcqeg; NQAch: $this->Log->toFile("\x4e\117\x20\105\x58\x54\x45\116\x53\x49\x4f\x4e\x20\111\116\40\101\163\164\104\x42"); goto XPHbD; XPHbD: $this->extension = GetPhone::load($this->config, array("\x75\151\x64" => $this->USER_ID))->Run(); goto acaDt; VqrZj: if (!empty($this->extension)) { goto QUZTI; } goto k_VNM; Dd9jZ: Z1WQw: goto NQAch; aN6cj: $this->Log->toFile("\x45\x58\x54\105\116\x53\x49\x4f\116\72\x20" . $this->extension); goto LJvQF; ZNZ04: } protected function noRoute() { goto ZnBaF; bsHY3: $routeFound = !$route && strlen($this->destination) > 4; goto ONoXv; vXx91: $this->Log->toFile("\x21\122\x4f\125\x54\x45\40\116\117\124\40\106\117\125\x4e\104\x21"); goto oypGd; mMPCb: return $routeFound; goto qPxsK; ONoXv: if (!$routeFound) { goto sfZtu; } goto vXx91; ZnBaF: $route = !$this->config["\x72\x6f\x75\x74\145\103\x68\x65\x63\153"] || checkOutboundRoute::Run($this->config, $this->destination); goto bsHY3; oypGd: sfZtu: goto mMPCb; qPxsK: } protected function errorStatus($status) { goto S8bPO; Ga4Z1: $this->Log->toFile(array("\x4f\162\151\147\151\156\141\x74\145\x20\123\164\141\164\x75\163" => $status)); goto RsDaR; BZ06N: if (!$error) { goto PzIXt; } goto Ga4Z1; RsDaR: PzIXt: goto PKzzR; S8bPO: $error = trim($status["\122\x65\163\160\157\x6e\163\x65"]) == "\105\x72\162\x6f\162"; goto BZ06N; PKzzR: return $error; goto mOEtC; mOEtC: } protected function setDestination() { goto uRrRx; O9I6L: $this->destination = !empty($prefix) ? $prefix . preg_replace("\57\134\x2b\x2f", '', $this->callerID) : $this->callerID; goto AYzzo; uRrRx: $prefix = Lines::load()->getPrefixByNumber($this->LINE_NUMBER); goto ccwwd; ccwwd: $this->Log->toFile("\120\x52\x45\x46\111\x58\72\x20" . $prefix); goto O9I6L; AYzzo: } }
