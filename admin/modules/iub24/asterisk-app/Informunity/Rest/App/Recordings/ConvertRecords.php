<?php
 namespace Informunity\Rest\App\Recordings; use Informunity\Log; use Informunity\Rest\Custom; class ConvertRecords { public $config; protected $log; protected $data; protected $freePBXAudioFormat; protected $recordingType; public function __construct($config, $data) { goto KjB6A; eDikC: $this->log = new Log(array("\150\145\141\144\x65\x72" => "\x4d\145\144\x69\141\x20\143\157\x6e\166\x65\162\x74\x65\162", "\141\163\164\145\x72\151\x73\x6b\137\143\x61\154\x6c\x69\x64" => $this->config["\x61\x73\x74\145\162\x69\x73\x6b\x5f\143\x61\x6c\x6c\151\x64"]), $this->config["\x6c\157\x67\147\151\156\x67"]); goto urfZw; k8CUi: $this->freePBXAudioFormat = $amp_conf["\x4d\x49\x58\115\x4f\x4e\x5f\x46\117\x52\115\x41\x54"]; goto MLeUi; urfZw: global $amp_conf; goto k8CUi; cJ0Yn: $this->data = $data; goto eDikC; KjB6A: $this->config = $config; goto cJ0Yn; MLeUi: $this->recordingType = $this->config["\162\x65\x63\x6f\x72\x64\x69\156\x67\x73"]; goto Rroei; Rroei: } public static function load($config, $data = array()) { return Custom::GetCustomData($config, $data, __CLASS__); } public function Run() { goto p05G1; GHlAj: foreach ($this->data as $key => $value) { goto qC3ME; QFDyh: $delete = array_merge($delete, $conv["\144\145\x6c\145\164\145"]); goto pZAcB; fAoHD: ErFoc: goto lesK3; tTpMk: if (!(!empty($conv) && is_array($conv))) { goto ErFoc; } goto QczJL; lesK3: jcMWj: goto isM9x; ufY7v: $update[$key] = $conv["\146\151\x6c\x65"]; goto bybc6; bybc6: GLOXC: goto hD52x; pZAcB: l3Gkp: goto fAoHD; hD52x: if (!isset($conv["\x64\145\x6c\x65\164\x65"])) { goto l3Gkp; } goto QFDyh; QczJL: if (!isset($conv["\x66\151\154\x65"])) { goto GLOXC; } goto ufY7v; qC3ME: $conv = $this->ConvertFile($value); goto tTpMk; isM9x: } goto CcMsV; NJ50G: xMYVU: goto Nmtuw; p05G1: if (fpbx_which("\x66\146\x6d\x70\145\x67")) { goto xMYVU; } goto CMQX9; oU1ic: return array("\x75\x70\x64\x61\x74\x65" => isset($update) && is_array($update) ? array_values($update) : array(), "\144\145\x6c\x65\164\145" => isset($delete) && is_array($delete) ? $delete : array()); goto Z9std; CMQX9: $this->log->toFile(array("\x57\141\x72\x6e\x69\x6e\147" => "\x66\x66\155\160\x65\x67\x20\x61\160\x70\x20\151\163\40\156\x6f\164\x20\151\x6e\163\164\x61\154\x6c\x65\x64")); goto l5aZK; Nmtuw: $delete = array(); goto GHlAj; l5aZK: goto TCoCP; goto NJ50G; Z9std: TCoCP: goto fsD05; CcMsV: N9OhK: goto oU1ic; fsD05: } protected function parseProbe($out) { goto CrDGJ; Lw1yQ: pX_zb: goto OTHSp; lyEgw: if (!empty($decode["\146\157\x72\x6d\x61\x74"])) { goto pX_zb; } goto g1jny; UZKFW: return 0; goto UpBrj; CrDGJ: $result = implode($out); goto Ncto_; UpBrj: yGLtt: goto C7BmJ; g1jny: return 0; goto Lw1yQ; C7BmJ: return (float) $decode["\x66\157\x72\155\x61\x74"]["\x64\165\162\x61\x74\151\157\156"]; goto PCFaL; Ncto_: $decode = json_decode($result, true); goto lyEgw; OTHSp: if (!empty($decode["\x66\x6f\162\x6d\141\164"]["\x64\x75\162\x61\x74\x69\x6f\x6e"])) { goto yGLtt; } goto UZKFW; PCFaL: } protected function ConvertFile($file) { goto lzgIr; Ogt1N: return $send; goto I9t_x; a1s1F: mpvos: goto p_z2S; Ii3Eu: if (!file_exists($fileInfo["\x6d\x70\x33"])) { goto mpvos; } goto no_n8; lzgIr: $fileInfo = $this->fileInfo($file); goto lC13r; eakWY: exec($cmdProbe, $out); goto ahRr2; ahRr2: $fileLength = $this->parseProbe($out); goto h0MOz; lC13r: $cmdProbe = $this->cmdProbe($fileInfo); goto eakWY; no_n8: $this->log->toFile(array("\x46\x69\x6c\x65" => $fileInfo["\155\160\x33"], "\x43\162\x65\141\x74\x65\144", "\104\x75\x72\x61\164\151\157\156" => $fileLength . "\40\x73\x65\x63\56")); goto Q9z2F; p_z2S: $send["\x64\145\x6c\145\164\x65"] = $fileInfo["\x64\145\154\x65\x74\145"]; goto Ogt1N; sqlsG: exec($cmdLine); goto kBxMg; ut0vG: COfTQ: goto yafQT; yafQT: $cmdLine = $this->cmdConvert($fileInfo); goto sqlsG; kBxMg: VNAug: goto fTkne; lc0Tk: $this->log->toFile(array("\x46\151\154\x65" => $fileInfo["\x6d\160\63"], "\104\x75\x72\x61\164\x69\157\156" => "\60\x20\x73\x65\x63\x2e")); goto QScE4; h0MOz: if ($fileLength > 0) { goto COfTQ; } goto lc0Tk; fTkne: $send = array(); goto Ii3Eu; QScE4: goto VNAug; goto ut0vG; Q9z2F: $send["\146\151\x6c\x65"] = $fileInfo["\x6d\160\x33"]; goto a1s1F; I9t_x: } protected function fileInfo($file) { goto rT7QH; AhnP_: w0Da8: goto rUQNO; RnQTF: switch ($recType) { case "\x73\164\x65\x72\x65\157": goto BtSI8; VUQxD: goto pJr2a; goto rInvN; BtSI8: $fullPath = $this->config["\162\x65\x63\157\162\144\x69\x6e\147\x73\x50\141\x74\x68"] . $file . "\56\167\141\x76"; goto oJY9p; mJiys: $fileData["\x64\x65\154\x65\x74\145"] = array($fileData["\x6d\160\x33"], $fileData["\x73\164\x65\x72\x65\157"]["\x6c\145\x66\x74"], $fileData["\x73\164\145\162\145\157"]["\x72\x69\147\150\x74"]); goto VUQxD; oJY9p: $fileData = array_merge(pathinfo($fullPath), array("\146\165\154\154\x50\x61\x74\150" => $fullPath, "\x73\x74\145\x72\145\x6f" => array("\x6c\145\x66\164" => $this->config["\162\145\143\157\x72\x64\151\156\x67\163\x50\141\164\x68"] . $file . "\x5f\111\x6e\163\x69\144\x65\56\167\141\x76", "\162\151\x67\x68\x74" => $this->config["\162\145\x63\157\162\144\151\156\x67\x73\120\x61\x74\x68"] . $file . "\137\x4f\165\164\163\x69\144\145\x2e\x77\x61\x76"), "\155\x70\63" => $this->config["\x72\x65\143\157\x72\x64\x69\156\147\x73\x50\141\164\150"] . $file . "\x2e\x6d\x70\x33")); goto mJiys; rInvN: case "\166\x6d": goto e2Npq; Si2Dg: goto pJr2a; goto RagDN; NRn_F: $fileData = array_merge(pathinfo($fullPath), array("\146\x75\x6c\154\x50\141\164\x68" => $fullPath, "\x6d\160\x33" => $this->uniqueFileName($file) . "\56\155\160\63")); goto vhfNr; vhfNr: $fileData["\144\x65\x6c\145\x74\x65"] = array($fileData["\x6d\160\63"]); goto Si2Dg; e2Npq: $fullPath = $file; goto NRn_F; RagDN: default: goto x5i_Q; PFOfu: $info = pathinfo($fullPath); goto FMS0P; yh_3F: goto pJr2a; goto T2GXP; Z7MbA: $fileData["\x64\x65\x6c\x65\164\x65"] = array($fileData["\x6d\x70\x33"]); goto zqZTH; pM4x5: RE6cW: goto y41v_; x5i_Q: $fullPath = $this->config["\x72\x65\x63\157\162\144\x69\x6e\x67\x73\120\x61\x74\x68"] . $file; goto PFOfu; qpZdc: if ($this->config["\165\x70\144\141\164\x65\x43\x44\x52"]) { goto RE6cW; } goto Z7MbA; zqZTH: goto gzvzX; goto pM4x5; Mnq7J: gzvzX: goto yh_3F; y41v_: $this->updateCDR($fileData); goto Mnq7J; FMS0P: $fileData = array_merge($info, array("\x66\x75\x6c\x6c\x50\x61\164\x68" => $fullPath, "\x6d\160\63" => $info["\x64\151\x72\x6e\x61\x6d\x65"] . "\x2f" . $info["\x66\151\154\145\x6e\141\155\145"] . "\x2e\x6d\160\63")); goto qpZdc; T2GXP: } goto AhnP_; zdP1q: if (!($this->recordingType === "\163\x74\145\x72\x65\157" && file_exists($this->config["\x72\145\x63\157\162\144\x69\156\147\163\x50\x61\x74\x68"] . $file . "\x5f\111\x6e\163\151\144\145\56\x77\141\x76") && file_exists($this->config["\162\145\x63\x6f\x72\144\151\156\x67\163\x50\x61\164\150"] . $file . "\x5f\x4f\x75\x74\163\x69\x64\x65\56\x77\x61\166"))) { goto V8vgS; } goto ofoPg; luQlB: xnrCq: goto zdP1q; rUQNO: pJr2a: goto qPpRt; l3qWQ: $recType = "\166\155"; goto luQlB; PtfF4: if (!file_exists($file)) { goto xnrCq; } goto l3qWQ; qPpRt: return $fileData; goto V97I8; V2V0f: V8vgS: goto RnQTF; ofoPg: $recType = "\x73\x74\x65\x72\x65\157"; goto V2V0f; rT7QH: $recType = ''; goto PtfF4; V97I8: } protected function cmdProbe($fileInfo) { goto R0aiI; QULPW: if (!($fileInfo["\145\x78\164\145\156\x73\x69\157\x6e"] === "\x75\x6c\141\167")) { goto hX6X1; } goto rzVjB; pZeLN: Zt4uo: goto d0ETV; d0ETV: array_push($cmdArray, "\x2d\166", "\x71\165\151\145\x74", "\55\x70\162\x69\x6e\164\x5f\x66\x6f\162\155\x61\x74", "\x6a\x73\157\x6e\x3d\x63\157\155\160\141\143\164\x3d\x31", "\55\x73\x68\157\x77\137\146\x6f\162\x6d\141\x74"); goto xmSll; kokiw: $cmdArray[] = "\x32\x3e\46\61"; goto yjQpt; fH30o: if (!($fileInfo["\x65\x78\164\145\x6e\x73\x69\x6f\156"] === "\x61\154\x61\x77")) { goto Zt4uo; } goto kW9L8; rzVjB: array_push($cmdArray, "\55\x66", "\x6d\165\x6c\x61\x77"); goto leNpy; leNpy: hX6X1: goto fH30o; xmSll: array_push($cmdArray, "\55\151", $this->recordingType === "\x73\x74\145\162\x65\x6f" && file_exists($fileInfo["\163\164\x65\x72\145\157"]["\154\145\x66\164"]) ? $fileInfo["\163\164\145\162\145\x6f"]["\154\x65\x66\164"] : $fileInfo["\x66\x75\x6c\154\120\141\x74\150"]); goto kokiw; yjQpt: return implode("\40", $cmdArray); goto keq7F; kW9L8: array_push($cmdArray, "\x2d\x66", "\141\x6c\141\167"); goto pZeLN; R0aiI: $cmdArray = array(fpbx_which("\x66\x66\x70\x72\157\142\145")); goto QULPW; keq7F: } protected function cmdConvert($fileInfo) { goto JUQBZ; oTKAJ: if (!($fileInfo["\145\170\x74\145\x6e\163\151\157\x6e"] === "\x61\154\141\167")) { goto Ie6tF; } goto PtA5t; cIf43: TC5qD: goto oTKAJ; neSfr: gGyVV: goto kvx66; VSjsi: global $amp_conf; goto bFiIR; LO5_M: goto fhJ9C; goto vzfPW; IallU: array_push($cmdArray, "\x2d\151", $fileInfo["\146\x75\x6c\154\120\x61\x74\150"]); goto LO5_M; JUQBZ: $cmdArray = array(fpbx_which("\x66\146\x6d\x70\145\x67")); goto zLAzn; vzfPW: VMOLH: goto v7Gyt; tc4Id: if (!($fileInfo["\145\170\x74\145\x6e\x73\x69\x6f\x6e"] === "\x61\154\x61\167" || $fileInfo["\x65\x78\x74\x65\x6e\x73\151\157\x6e"] === "\x75\x6c\141\167")) { goto gGyVV; } goto KSctm; wWjJ3: if ($this->recordingType === "\163\x74\145\162\x65\157") { goto VMOLH; } goto IallU; S1zdz: $bitrate = "\x31\66\153"; goto hfGAk; PAeYs: Ie6tF: goto wWjJ3; kvx66: $bitrate = "\x31\x39\x32\153"; goto VSjsi; zLAzn: if (!($fileInfo["\x65\170\164\x65\156\x73\x69\x6f\156"] === "\x75\154\141\167")) { goto TC5qD; } goto UYp_4; UYp_4: array_push($cmdArray, "\x2d\x66", "\x6d\165\154\x61\167"); goto cIf43; dRNvr: fhJ9C: goto tc4Id; q_Crg: return implode("\40", $cmdArray); goto r_7DI; KSctm: array_push($cmdArray, "\55\x61\146", "\x61\x73\145\164\x72\141\x74\x65\75\70\x30\60\60"); goto neSfr; bFiIR: if (!($amp_conf["\115\111\x58\x4d\117\116\x5f\x46\x4f\122\x4d\101\124"] === "\x57\x41\126")) { goto qw_BG; } goto S1zdz; Ny4aY: array_push($cmdArray, "\x2d\141\x62", $bitrate, $fileInfo["\155\x70\x33"]); goto q_Crg; v7Gyt: array_push($cmdArray, "\x2d\151", $fileInfo["\x73\164\x65\162\145\157"]["\x6c\x65\146\x74"], "\55\x69", $fileInfo["\x73\x74\x65\162\145\157"]["\162\x69\x67\x68\164"], "\x2d\x66\151\154\164\145\162\137\143\x6f\155\x70\154\x65\x78", "\x27\x5b\60\72\x61\x5d\x5b\61\x3a\x61\135\x6a\x6f\151\x6e\x3d\x69\x6e\x70\165\x74\x73\75\62\x3a\143\150\x61\156\156\145\154\x5f\x6c\x61\171\x6f\x75\164\75\163\x74\x65\x72\x65\157\x5b\141\135\x27", "\55\x6d\x61\x70", "\x27\133\x61\135\x27"); goto dRNvr; hfGAk: qw_BG: goto Ny4aY; PtA5t: array_push($cmdArray, "\x2d\x66", "\141\x6c\141\x77"); goto PAeYs; r_7DI: } public function uniqueFileName($file) { $date = new \DateTime(); return strlen($file) > 10 ? $file : $date->format("\131\x6d\144\55\x48\151\163") . "\x2d" . $date->getTimestamp(); } protected function updateCDR(&$fileData) { goto r898k; Cz4tD: $db = \FreePBX::Database(); goto K_Npa; KFqY0: $sth->bindParam("\x3a\157\x72\151\x67\x69\156\x61\154", $original, \PDO::PARAM_STR); goto vNtqQ; DeRXZ: $mp3 = $recordFileWithoutExten . "\x2e\x6d\x70\63"; goto L_5tM; VL1dP: $recordFileWithoutExten = pathinfo($fileData["\x62\141\163\x65\x6e\141\155\x65"], PATHINFO_FILENAME); goto DeRXZ; L_5tM: $original = $recordFileWithoutExten . "\45"; goto i1Q1y; vNtqQ: $sth->execute(); goto sPtuY; r898k: $fileData["\x64\x65\x6c\145\164\x65"] = array($fileData["\146\165\x6c\154\x50\x61\x74\150"]); goto Cz4tD; i1Q1y: $sth->bindParam("\x3a\155\160\x33", $mp3, \PDO::PARAM_STR); goto KFqY0; K_Npa: $sth = $db->prepare("\x55\120\x44\x41\x54\105\x20\141\163\164\145\162\x69\x73\153\x63\x64\x72\x64\x62\56\143\144\x72\40\x53\x45\x54\40\162\145\x63\x6f\x72\x64\151\156\147\x66\x69\154\x65\x3d\x3a\155\x70\x33\40\127\110\x45\x52\x45\40\x72\145\143\x6f\162\x64\151\x6e\x67\146\151\x6c\145\x20\x4c\111\x4b\105\40\72\x6f\162\151\x67\151\156\x61\x6c"); goto VL1dP; sPtuY: } }
